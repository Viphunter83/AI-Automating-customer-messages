# ============================================
# ПЕРЕМЕННЫЕ ОКРУЖЕНИЯ ДЛЯ ДОКПЛОЙ
# ============================================
# Этот файл содержит настройки для всех четырех сервисов:
# 1. Supabase (self-hosted)
# 2. Redis
# 3. Backend (FastAPI приложение)
# 4. Frontend (Next.js админка)
#
# Скопируйте этот файл в .env и заполните реальными значениями
# НЕ КОММИТЬТЕ .env в git!

# ============================================
# 1. SUPABASE (Self-hosted)
# ============================================
# Supabase разворачивается как отдельный сервис в Dokploy
# Настройки подключения к Supabase:

# ВАРИАНТ 1: Подключение через REST API (рекомендуется)
# URL Supabase API Gateway (Kong или внешний URL)
# Для внутреннего доступа в Dokploy:
SUPABASE_URL=http://kong:8000
# Или для внешнего доступа:
# SUPABASE_URL=https://supabase.your-domain.com

# REST API URL (обычно SUPABASE_URL + /rest/v1)
# Примечание: В .env файлах стандартные парсеры НЕ поддерживают интерполяцию переменных
# Замените ${SUPABASE_URL} на реальное значение или укажите полный URL:
SUPABASE_REST_URL=http://kong:8000/rest/v1
# Или если используете внешний URL:
# SUPABASE_REST_URL=https://supabase.your-domain.com/rest/v1

# API ключи (получите из Supabase Dashboard → Settings → API)
SUPABASE_ANON_KEY=your-anon-key-here
SUPABASE_SERVICE_KEY=your-service-role-key-here  # Для административных операций (обход RLS)

# ВАРИАНТ 2: Прямое подключение к PostgreSQL
# Если используете прямое подключение к БД Supabase:

# Для локального Supabase (внутри Docker сети):
SUPABASE_USER=postgres
SUPABASE_PASSWORD=your-db-password
SUPABASE_HOST=db  # Имя сервиса БД в Docker сети (или оставьте пустым для значения по умолчанию)
SUPABASE_PORT=5437  # Порт БД (для self-hosted обычно 5437)
SUPABASE_DB=postgres  # Имя базы данных
DATABASE_ECHO=false  # Логирование SQL запросов (true/false)

# Для внешнего Supabase (production):
# SUPABASE_USER=postgres
# SUPABASE_PASSWORD=your-db-password  # ⚠️ ОБЯЗАТЕЛЬНО для внешнего подключения!
# SUPABASE_HOST=supabase.dev.neiromatrius.zerocoder.pro  # ⚠️ Внешний хост
# SUPABASE_PORT=5437
# SUPABASE_DB=postgres
# DATABASE_ECHO=false

# Альтернатива: полная строка подключения
# DATABASE_URL=postgresql+asyncpg://postgres:password@db:5437/postgres

# ============================================
# 2. REDIS
# ============================================
# Redis разворачивается через docker-compose.redis.yml
# Команда запуска: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru

# URL для подключения к Redis
# Для Redis сервиса в Dokploy (внутри Docker сети):
REDIS_URL=redis://neiromatrius-redis:6379/0

# Для внешнего Redis (если используете внешний сервис):
# REDIS_URL=redis://your-redis-host:6379/0
# Или с паролем:
# REDIS_URL=redis://:password@your-redis-host:6379/0

# Если Redis не используется (не рекомендуется для production):
# REDIS_URL=

# ============================================
# 3. BACKEND (FastAPI приложение)
# ============================================
# Backend разворачивается через docker-compose.backend.yml
# Команда запуска: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
# (через entrypoint.sh)

# === DATABASE ===
# Используется Supabase (см. секцию 1 выше)
# Если не используете Supabase параметры, укажите DATABASE_URL напрямую:
# DATABASE_URL=postgresql+asyncpg://user:password@host:port/database

# === OPENAI / LLM ===
OPENAI_API_KEY=sk-xxxxx
OPENAI_API_BASE=https://api.proxyapi.ru/openai/v1
OPENAI_MODEL=gpt-4o-mini

# === APP CONFIGURATION ===
APP_NAME=AI Customer Support
APP_VERSION=1.0.0
DEBUG=false  # Для production установите false
LOG_LEVEL=INFO

# === SECURITY ===
# ⚠️ ВАЖНО: Сгенерируйте уникальный секретный ключ!
# Можно использовать: openssl rand -hex 32
SECRET_KEY=your-secret-key-here-change-in-production-min-32-chars

# CORS origins (JSON array или через запятую)
ALLOWED_ORIGINS=["https://your-frontend-domain.com","https://admin.your-domain.com"]
# Для разработки:
# ALLOWED_ORIGINS=["http://localhost:3000","http://localhost:8000"]

# === AI SETTINGS ===
AI_CLASSIFICATION_TIMEOUT=30
AI_CONFIDENCE_THRESHOLD=0.85

# === RATE LIMITING ===
RATE_LIMIT_ENABLED=true
RATE_LIMIT_PER_MINUTE=60
RATE_LIMIT_PER_HOUR=1000
RATE_LIMIT_MESSAGE_PER_MINUTE=10

# === MESSAGE DELIVERY ===
RESPONSE_DELAY_SECONDS=3.0
FAREWELL_DELAY_SECONDS=10.0
DELAYS_ENABLED=true
MESSAGE_DELIVERY_DELAY_SECONDS=0

# === TELEGRAM BOT (optional) ===
# Получите токен у @BotFather в Telegram
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_ENABLED=false  # Установите true для включения бота

# Webhook настройки (для production)
TELEGRAM_WEBHOOK_URL=https://your-backend-domain.com/api/integrations/telegram/webhook
TELEGRAM_WEBHOOK_SECRET=your_webhook_secret_here
TELEGRAM_WEBHOOK_BASE_URL=https://your-backend-domain.com

# === DOCKER SETTINGS ===
# Устанавливается автоматически в docker-compose файлах
DOCKER_ENV=true

# ============================================
# 4. FRONTEND (Next.js админка)
# ============================================
# Frontend разворачивается через docker-compose.frontend.yml
# Команда запуска: npm start (production build)
# (через Dockerfile CMD)

# === NEXT.JS CONFIGURATION ===
NODE_ENV=production
NEXT_PUBLIC_API_URL=/api  # Для production через прокси

# === BACKEND API URL ===
# URL backend для server-side запросов
# В Dokploy используйте имя контейнера backend в Docker сети:
BACKEND_API_URL=http://neiromatrius-backend:8000

# Или если backend на другом домене:
# BACKEND_API_URL=https://your-backend-domain.com

# ============================================
# ОБЩИЕ НАСТРОЙКИ
# ============================================

# === DOCKER NETWORK ===
# Имя Docker сети (создается автоматически Dokploy)
NETWORK_NAME=neiromatrius-network

# ============================================
# ПРИМЕЧАНИЯ
# ============================================
#
# 1. Supabase:
#    - Разворачивается как отдельный сервис в Dokploy
#    - Миграции выполняются вручную через SQL Editor
#    - Используйте SUPABASE_URL для REST API или параметры для прямого подключения
#
# 2. Redis:
#    - Разворачивается через docker-compose.redis.yml
#    - Команда: redis-server --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru
#    - Используйте имя контейнера neiromatrius-redis для подключения
#
# 3. Backend:
#    - Разворачивается через docker-compose.backend.yml
#    - Команда: uvicorn main:app --host 0.0.0.0 --port 8000 --workers 4
#    - Использует entrypoint.sh для запуска
#
# 4. Frontend:
#    - Разворачивается через docker-compose.frontend.yml
#    - Команда: npm start (production build)
#    - Использует Dockerfile CMD
#
# ============================================
# БЕЗОПАСНОСТЬ
# ============================================
#
# Храните секретные значения в Secrets Dokploy:
# - SECRET_KEY
# - OPENAI_API_KEY
# - TELEGRAM_BOT_TOKEN
# - TELEGRAM_WEBHOOK_SECRET
# - SUPABASE_SERVICE_KEY
# - DATABASE_URL (если содержит пароль)
# - SUPABASE_PASSWORD
