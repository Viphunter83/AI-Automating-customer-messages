# üîß –í—Ç–æ—Ä–æ–π —Ä–∞—É–Ω–¥ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π - –ö—Ä–∏—Ç–∏—á–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã –¥–ª—è production

**–î–∞—Ç–∞:** 2025-11-26  
**–°—Ç–∞—Ç—É—Å:** ‚úÖ –í–´–ü–û–õ–ù–ï–ù–û

---

## ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. 5.3 Rate Limiting ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∑–∞—â–∏—Ç—ã –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è API

**–†–µ—à–µ–Ω–∏–µ:**
- –ü–æ–¥–∫–ª—é—á–µ–Ω `slowapi` –¥–ª—è rate limiting –ø–æ IP
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –∫–∞—Å—Ç–æ–º–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ rate limit –ø–æ `client_id` (10 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω—É—Ç—É)
- –ù–∞—Å—Ç—Ä–æ–µ–Ω—ã –ª–∏–º–∏—Ç—ã: 60 –∑–∞–ø—Ä–æ—Å–æ–≤/–º–∏–Ω—É—Ç—É, 1000 –∑–∞–ø—Ä–æ—Å–æ–≤/—á–∞—Å –ø–æ IP
- Graceful degradation –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ slowapi

**–§–∞–π–ª—ã:**
- `backend/app/config.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ rate limiting
- `backend/app/__init__.py` - –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è rate limiter
- `backend/app/routes/messages.py` - –ø—Ä–æ–≤–µ—Ä–∫–∞ rate limit –ø–æ client_id
- `backend/requirements.txt` - –¥–æ–±–∞–≤–ª–µ–Ω slowapi==0.1.8

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ API –∑–∞—â–∏—â–µ–Ω –æ—Ç –∑–ª–æ—É–ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –∏ DDoS –∞—Ç–∞–∫

---

### 2. 5.2 N+1 Queries ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ú–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤–º–µ—Å—Ç–æ –æ–¥–Ω–æ–≥–æ

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω eager loading (`selectinload`) –¥–ª—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–π –≤ `get_client_messages`
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω `search_dialogs` - batch loading –≤—Å–µ—Ö –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–π –∏ feedbacks
- –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω `get_misclassified_messages` - batch loading –≤—Å–µ—Ö messages –∏ classifications
- –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω—ã JOIN –∑–∞–ø—Ä–æ—Å—ã –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

**–§–∞–π–ª—ã:**
- `backend/app/routes/messages.py` - eager loading –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏–π
- `backend/app/services/search_service.py` - batch loading –¥–ª—è –¥–∏–∞–ª–æ–≥–æ–≤
- `backend/app/services/model_retraining.py` - batch loading –¥–ª—è misclassified messages

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∏–∂–µ–Ω–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î

---

### 3. 4.2 –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ë–î ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ check constraints –∏ unique constraints

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω check constraint –¥–ª—è confidence (0-1)
- –î–æ–±–∞–≤–ª–µ–Ω partial unique index –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —à–∞–±–ª–æ–Ω–æ–≤ (–æ–¥–∏–Ω –∞–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω –Ω–∞ —Å—Ü–µ–Ω–∞—Ä–∏–π)
- –£–ª—É—á—à–µ–Ω—ã foreign key constraints

**–§–∞–π–ª—ã:**
- `backend/migrations/versions/006_add_performance_indexes.py` - –¥–æ–±–∞–≤–ª–µ–Ω—ã constraints

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∞ —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —É—Ä–æ–≤–Ω–µ –ë–î

---

### 4. 7.2 –í–∞–ª–∏–¥–∞—Ü–∏—è Frontend ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –≤–∞–ª–∏–¥–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ API –Ω–∞ frontend

**–†–µ—à–µ–Ω–∏–µ:**
- –°–æ–∑–¥–∞–Ω—ã Zod —Å—Ö–µ–º—ã –¥–ª—è –≤—Å–µ—Ö —Ç–∏–ø–æ–≤ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ axios interceptor
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ React Query hooks
- –£–ª—É—á—à–µ–Ω–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ —Å retry –º–µ—Ö–∞–Ω–∏–∑–º–æ–º

**–§–∞–π–ª—ã:**
- `frontend/lib/validation.ts` - Zod —Å—Ö–µ–º—ã –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- `frontend/lib/api.ts` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ interceptor
- `frontend/hooks/useMessages.ts` - –≤–∞–ª–∏–¥–∞—Ü–∏—è –≤ hooks

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω—ã runtime –æ—à–∏–±–∫–∏ –æ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö

---

### 5. 9.1 –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ ‚úÖ

**–ü—Ä–æ–±–ª–µ–º–∞:** –ù–µ–ø–æ–ª–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–†–µ—à–µ–Ω–∏–µ:**
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ë–î —Å —Ç–µ—Å—Ç–æ–≤—ã–º –∑–∞–ø—Ä–æ—Å–æ–º
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ OpenAI API –∫–ª–∏–µ–Ω—Ç–∞
- –£–ª—É—á—à–µ–Ω–æ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –ø—Ä–æ–≤–µ—Ä–æ–∫

**–§–∞–π–ª—ã:**
- `backend/app/__init__.py` - —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ

**–†–µ–∑—É–ª—å—Ç–∞—Ç:** ‚úÖ –†–∞–Ω–Ω–µ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º —Å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–µ–π

---

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–π

| –ü—Ä–æ–±–ª–µ–º–∞ | –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç | –°—Ç–∞—Ç—É—Å |
|----------|-----------|--------|
| 5.3 Rate Limiting | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 5.2 N+1 Queries | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 4.2 –¶–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç—å –ë–î | üü† –í—ã—Å–æ–∫–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 7.2 –í–∞–ª–∏–¥–∞—Ü–∏—è Frontend | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |
| 9.1 –í–∞–ª–∏–¥–∞—Ü–∏—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ | üü° –°—Ä–µ–¥–Ω–∏–π | ‚úÖ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–æ |

**–í—Å–µ–≥–æ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–æ:** 5 –ø—Ä–æ–±–ª–µ–º  
**–ö—Ä–∏—Ç–∏—á–Ω—ã—Ö –¥–ª—è production:** 3  
**–£–ª—É—á—à–µ–Ω–∏–π –∫–∞—á–µ—Å—Ç–≤–∞:** 2

---

## üöÄ –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏

1. **–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –ë–î:**
   ```bash
   docker exec ai_support_backend sh -c "cd /app && python3 -m alembic -c migrations/alembic.ini upgrade head"
   ```

2. **–ü–µ—Ä–µ—Å–æ–±—Ä–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã** (–¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ slowapi):
   ```bash
   docker-compose build backend
   docker-compose up -d
   ```

3. **–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å:**
   - Rate limiting (–æ—Ç–ø—Ä–∞–≤–∏—Ç—å >10 —Å–æ–æ–±—â–µ–Ω–∏–π –æ—Ç –æ–¥–Ω–æ–≥–æ client_id)
   - –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î)
   - Frontend –≤–∞–ª–∏–¥–∞—Ü–∏—é (–ø—Ä–æ–≤–µ—Ä–∏—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)

---

## üìù –ü—Ä–∏–º–µ—á–∞–Ω–∏—è

- Rate limiting —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ —É—Ä–æ–≤–Ω–µ IP –∏ client_id
- N+1 queries –∏—Å–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
- Frontend –≤–∞–ª–∏–¥–∞—Ü–∏—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç runtime –æ—à–∏–±–∫–∏
- –í—Å–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è –æ–±—Ä–∞—Ç–Ω–æ —Å–æ–≤–º–µ—Å—Ç–∏–º—ã

---

**–°—Ç–∞—Ç—É—Å:** ‚úÖ –ì–æ—Ç–æ–≤–æ –∫ production –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é —Å —É–ª—É—á—à–µ–Ω–Ω–æ–π –∑–∞—â–∏—Ç–æ–π –∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å—é

