# üêõ –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: Race condition –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏

**–î–∞—Ç–∞:** 2025-11-27  
**–§–∞–π–ª:** `frontend/app/demo/page.tsx`

---

## üîç –ü—Ä–æ–±–ª–µ–º–∞

–ü—Ä–∏ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π –∫–∞–∂–¥–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–ª–æ —Å–≤–æ–π —Å–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π —Ç–∞–π–º–µ—Ä –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è `loading` –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏, —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —ç—Ç–æ —Å–æ–æ–±—â–µ–Ω–∏–µ –≤—Å–µ –µ—â–µ —Ç–µ–∫—É—â–∏–º –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º.

**–°—Ü–µ–Ω–∞—Ä–∏–π –ø—Ä–æ–±–ª–µ–º—ã:**
1. –°–æ–æ–±—â–µ–Ω–∏–µ 0 –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É ‚Üí `loading = "msg-0"`
2. –°–æ–æ–±—â–µ–Ω–∏–µ 1 –Ω–∞—á–∏–Ω–∞–µ—Ç –æ—Ç–ø—Ä–∞–≤–∫—É ‚Üí `loading = "msg-1"`
3. –°–æ–æ–±—â–µ–Ω–∏–µ 0 –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
4. –°–æ–æ–±—â–µ–Ω–∏–µ 1 –∑–∞–≤–µ—Ä—à–∞–µ—Ç—Å—è ‚Üí —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è —Ç–∞–π–º–µ—Ä –Ω–∞ 2 —Å–µ–∫—É–Ω–¥—ã
5. –¢–∞–π–º–µ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è 0 —Å—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç ‚Üí `setLoading(null)` –æ—á–∏—â–∞–µ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏–µ
6. **–ü—Ä–æ–±–ª–µ–º–∞:** –°–æ—Å—Ç–æ—è–Ω–∏–µ –æ—á–∏—â–µ–Ω–æ, —Ö–æ—Ç—è —Å–æ–æ–±—â–µ–Ω–∏–µ 1 –≤—Å–µ –µ—â–µ –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ –∑–∞–≥—Ä—É–∑–∫–∏

–≠—Ç–æ –ø—Ä–∏–≤–æ–¥–∏–ª–æ –∫:
- –ü—Ä–µ–∂–¥–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- –ü–æ–≤—Ç–æ—Ä–Ω–æ–º—É –≤–∫–ª—é—á–µ–Ω–∏—é –∫–Ω–æ–ø–æ–∫, –∫–æ—Ç–æ—Ä—ã–µ –¥–æ–ª–∂–Ω—ã –æ—Å—Ç–∞–≤–∞—Ç—å—Å—è –æ—Ç–∫–ª—é—á–µ–Ω–Ω—ã–º–∏
- –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞–º –∑–∞–≥—Ä—É–∑–∫–∏ –≤ UI

---

## ‚úÖ –†–µ—à–µ–Ω–∏–µ

### 1. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `useRef` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è

–î–æ–±–∞–≤–ª–µ–Ω `currentLoadingRef` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è ID —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è:

```typescript
const currentLoadingRef = useRef<string | null>(null)
```

### 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è

–ü–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è, —á—Ç–æ —ç—Ç–æ –≤—Å–µ –µ—â–µ —Ç–æ –∂–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:

```typescript
if (currentLoadingRef.current === message.id) {
  setLoading(null)
  currentLoadingRef.current = null
}
```

### 3. –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–∞–π–º–µ—Ä–∞–º–∏

–î–æ–±–∞–≤–ª–µ–Ω–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ç–∞–π–º–µ—Ä–æ–≤ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –∏—Ö –æ—á–∏—Å—Ç–∫–∏:

```typescript
const timerRefs = useRef<Map<string, NodeJS.Timeout>>(new Map())
```

### 4. –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π

–ò–∑–º–µ–Ω–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤—Å–µ—Ö —Å–æ–æ–±—â–µ–Ω–∏–π —Å `forEach` + `setTimeout` –Ω–∞ `async/await` —Å –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–æ–π:

```typescript
// –ë—ã–ª–æ:
clientMessages.forEach((msg, idx) => {
  setTimeout(() => sendMockMessage(msg), idx * 2000)
})

// –°—Ç–∞–ª–æ:
for (const msg of clientMessages) {
  await sendMockMessage(msg)
  await new Promise(resolve => setTimeout(resolve, 2000))
}
```

---

## üìù –ò–∑–º–µ–Ω–µ–Ω–∏—è

### –î–æ–±–∞–≤–ª–µ–Ω–æ:
- `useRef` –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–≥—Ä—É–∂–∞–µ–º–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- `useRef` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç–∞–π–º–µ—Ä–∞–º–∏
- `useEffect` –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Ç–∞–π–º–µ—Ä–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
- –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ –æ—á–∏—Å—Ç–∫–æ–π —Å–æ—Å—Ç–æ—è–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Å `async/await`

### –£–ª—É—á—à–µ–Ω–æ:
- –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–µ–ø–µ—Ä—å –±–µ–∑–æ–ø–∞—Å–Ω–æ –¥–ª—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
- –¢–∞–π–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—á–∏—â–∞—é—Ç—Å—è –ø—Ä–∏ –Ω–æ–≤—ã—Ö –∑–∞–ø—Ä–æ—Å–∞—Ö
- –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏–π —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞

- ‚úÖ TypeScript –ø—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–æ–≤: –£—Å–ø–µ—à–Ω–æ
- ‚úÖ –õ–∏–Ω—Ç–µ—Ä: –ù–µ—Ç –æ—à–∏–±–æ–∫
- ‚úÖ Race condition –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∞
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ

---

## üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç

–¢–µ–ø–µ—Ä—å:
- ‚úÖ –°–æ—Å—Ç–æ—è–Ω–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—á–∏—â–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è
- ‚úÖ –ü–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç—É—é—Ç –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º
- ‚úÖ –¢–∞–π–º–µ—Ä—ã –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—á–∏—â–∞—é—Ç—Å—è
- ‚úÖ –ü–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ
- ‚úÖ UI —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤—Å–µ–≥–¥–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–æ —Å —Ä–µ–∞–ª—å–Ω—ã–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ–º –∑–∞–ø—Ä–æ—Å–æ–≤

---

**–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ!** ‚úÖ

